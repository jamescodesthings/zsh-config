#!/usr/bin/env zsh


_reshim_description="Runs asdf reshim and fixes shims to avoid collision"
_reshim_flags[1]="--help"
_reshim_flag_descriptions[1]="Prints Help"

shims=('clear' 'tput' 'curl' 'gettext.sh' 'gettext' 'envsubst')

function _asdf_reshim_fix() {
  if is not existing "$ASDF_DIR/shims"; then

    echo "$c[red]$ASDF_DIR/shims not found, check that \$ASDF_DIR points to the right place.$c[reset]"
    return 1
  fi

  for shim in $shims; do
    without_nl=${shim:-1}
    SHIM="$ASDF_DIR/shims/$without_nl"
    if is file "$SHIM"; then
      sudo chmod -x "$SHIM"
      rm -f "$SHIM"
      echo "$c[green]Fixed$c[reset] $without_nl"
    else
      echo "$c[yellow]Skipped$c[reset] $without_nl $c[yellow], does not exist.$c[reset]"
    fi
  done
}

# asdf-reshim: Lazy issue mentions in a git commit -m
function asdf-reshim () {
  local DEPS=(
    is
    asdf
  )

  if ! deps $DEPS; then
    return
  fi

  if has-flag '--help' $@; then
    print-help $0 "$_reshim_description" "_reshim_flags" "_reshim_flag_descriptions"
    echo "\n$c[dim]Shims:$c[reset]"
    for shim in $shims; do
      echo "- $c[cyan]$shim$c[reset]"
    done
    return
  fi

  echo "$c[dim]Reshimming$c[reset] ASDF"
  asdf reshim
  RESULT=$?
  if is equal $RESULT 0; then
    echo "$c[dim]Reshimmed$c[reset] ASDF"
  else
    echo "$c[yellow]Something may have gone wrong, try running$c[reset] asdf reshim $c[yellow]manually.$[reset]"
  fi

  _asdf_reshim_fix
}

asdf-reshim "$@"
